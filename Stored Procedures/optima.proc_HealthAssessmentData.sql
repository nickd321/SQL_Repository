SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
-- =============================================
-- Author:		Nick Moore
-- Create date: 20130624
-- Description:	Optima-Sentara Health Assessment Data
--
-- Notes:
-- 
-- Updates:		WilliamPe 20130925
--				Added CS10 (Optima Group#) as last column
-- =============================================
CREATE PROCEDURE [optima].[proc_HealthAssessmentData]
	@inBeginDate DATETIME = NULL,
	@inEndDate DATETIME = NULL
AS
BEGIN

	SET NOCOUNT ON;
	
/*======================================================= SETS ======================================================*/	

	SET @inBeginDate = ISNULL(@inBeginDate,DATEADD(dd,DATEDIFF(dd,0,GETDATE())-1,0))
	SET @inEndDate = ISNULL(@inEndDate,DATEADD(dd,DATEDIFF(dd,0,GETDATE()),0))

	SELECT
		grp.GroupNumber,
		grp.GroupName,
		mem.EligMemberID,
		mem.EligMemberSuffix,
		mem.FirstName,
		mem.LastName,
		CONVERT(VARCHAR,mem.Birthdate,101) AS Birthdate,
		addr.Address1,
		addr.Address2,
		addr.City,
		addr.[State],
		addr.ZipCode,
		CONVERT(VARCHAR,ha.AssessmentCompleteDate,101) AS AssessmentCompleteDate,
		ha.AbsenteeDays,
		ha.Alcohol_Current,
		ha.Alcohol_Days5Plus,
		ha.Alcohol_Frequency,
		ha.Alcohol_MaxDrinks,
		ha.Alcohol_Remorse,
		ha.BloodPressure,
		ha.Cholesterol,
		ha.Condition_Allergies,
		ha.Condition_Arthritis,
		ha.Condition_Asthma,
		ha.Condition_BackNeck,
		ha.Condition_Cancer,
		ha.Condition_ChronicPain,
		ha.Condition_COPD,
		ha.Condition_Depression,
		ha.Condition_Diabetes,
		ha.Condition_GallbladderDisease,
		ha.Condition_HeartCirculatory,
		ha.Condition_Hyperlipidemia,
		ha.Condition_Hypertension,
		ha.Condition_MetabolicSyndrome,
		ha.Condition_Migraine,
		ha.Condition_Neurologic,
		ha.Condition_Obesity,
		ha.Condition_Osteoporosis,
		ha.Condition_SleepApnea,
		ha.Condition_StomachBowel,
		ha.Condition_Stroke,
		ha.CurrentHealthProblem,
		ha.Diet_BestMethod,
		ha.Diet_ConfidenceBoredom,
		ha.Diet_ConfidenceHolidays,
		ha.Diet_ConfidenceRestaurant,
		ha.Diet_ConfidenceUpset,
		ha.Diet_FastFoodFrequency,
		ha.Diet_FishServings,
		ha.Diet_FruitServings,
		ha.Diet_GrainServings,
		ha.Diet_MeatAltServings,
		ha.Diet_PoultryServings,
		ha.Diet_RedMeatServings,
		ha.Diet_Resources,
		ha.Diet_StageOfChange,
		ha.Diet_VegServings,
		ha.DriveSpeedLimit,
		ha.Education,
		ha.EmploymentDuration,
		ha.Exercise_AdvisedToIncrease,
		ha.Exercise_BestMethod,
		ha.Exercise_ConfidenceDiscomfort,
		ha.Exercise_ConfidenceHaveTime,
		ha.Exercise_ConfidenceMissGoals,
		ha.Exercise_ConfidenceTired,
		ha.Exercise_Light_Minutes,
		ha.Exercise_Moderate,
		ha.Exercise_Moderate_Minutes,
		ha.Exercise_Resources,
		ha.Exercise_StageOfChange,
		ha.Exercise_Vigorous,
		ha.Exercise_Vigorous_Minutes,
		ha.FastingGlucose,
		ha.FeltDown,
		ha.Gender,
		ha.Goals,
		ha.Hearing_Devices,
		ha.Hearing_Impairment,
		ha.Height_Inches,
		ha.Helmet,
		ha.Immunization_ChickenPox,
		ha.Immunization_Flu,
		ha.Immunization_HepA,
		ha.Immunization_HepB,
		ha.Immunization_Measles,
		ha.Immunization_Meningococcal,
		ha.Immunization_Tetanus,
		ha.Immunization_Zoster,
		ha.Income,
		ha.JobCategory,
		ha.LittleInterest,
		ha.MaritalStatus,
		ha.PainFrequency,
		ha.PainLevel,
		ha.PreferredLanguage,
		ha.PregnancyStatus,
		ha.Presenteeism_Distracted,
		ha.Presenteeism_Energetic,
		ha.Presenteeism_Focus,
		ha.Presenteeism_Hopeless,
		ha.Presenteeism_Stress,
		ha.Presenteeism_Tasks,
		ha.Preventive_Aspirin,
		ha.Preventive_BloodPressure,
		ha.Preventive_Chlamydia,
		ha.Preventive_Cholesterol,
		ha.Preventive_Colonoscopy,
		ha.Preventive_Mammo,
		ha.Preventive_Pap,
		ha.Preventive_Stool,
		ha.ReadingAid,
		ha.RecreationalDrugUse,
		ha.SafeSex,
		ha.SeatBelt,
		ha.SecondhandSmoke,
		ha.SelfRatedHealth,
		ha.SelfRatedHealth_YearAgo,
		ha.Sleep_Hours,
		ha.Sleep_WakeupFeeling,
		ha.Stress_StageOfChange,
		ha.StressLevel_Health,
		ha.StressLevel_Home,
		ha.StressLevel_Work,
		ha.StressManage_Health,
		ha.StressManage_Home,
		ha.StressManage_Work,
		ha.Tobacco_BestMethod,
		ha.Tobacco_ConfidenceMorning,
		ha.Tobacco_ConfidenceSocializing,
		ha.Tobacco_ConfidenceTV,
		ha.Tobacco_ConfidenceUpset,
		CONVERT(VARCHAR,ha.Tobacco_QuitDate,101) AS Tobacco_QuitDate,
		ha.Tobacco_Resources,
		ha.Tobacco_StageOfChange,
		ha.Tobacco_Use,
		ha.TobaccoStatements,
		ha.Utilization_ERVisits,
		ha.Utilization_InpatientAdmissions,
		ha.Utilization_PhysicianVisits,
		ha.VisionImpairment,
		ha.WaistCircumference,
		ha.Weight_BestMethod,
		ha.Weight_CarryExcess,
		ha.Weight_ConfidenceGeneral,
		ha.Weight_Fluctuation,
		ha.Weight_Pounds,
		ha.Weight_Resources,
		ha.Weight_SelfPerceivedLoss,
		ha.Weight_StageOfChange,
		ha.WorkCulture_Control,
		ha.WorkCulture_Demands,
		ha.WorkCulture_Relationships,
		ha.WorkCulture_Reward,
		ha.WorkCulture_Role,
		ha.WorkCulture_Support,
		cs.CS10 AS Optima_GroupNumber
	FROM
		DA_Production.prod.HealthPlanGroup grp
	JOIN
		DA_Production.prod.Member mem
		ON	(grp.GroupID = mem.GroupID)
	LEFT JOIN
		DA_Production.prod.[Address] addr
		ON	(mem.MemberID = addr.MemberID)
		AND	(addr.AddressTypeID = 6)
	LEFT JOIN
		DA_Production.prod.CSFields cs
		ON	(mem.MemberID = cs.MemberID)
	JOIN
		(
		SELECT
			MemberID,
			AssessmentCompleteDate,
			AbsenteeDays,
			Alcohol_Current,
			Alcohol_Days5Plus,
			Alcohol_Frequency,
			Alcohol_MaxDrinks,
			Alcohol_Remorse,
			BloodPressure,
			Cholesterol,
			Condition_Allergies,
			Condition_Arthritis,
			Condition_Asthma,
			Condition_BackNeck,
			Condition_Cancer,
			Condition_ChronicPain,
			Condition_COPD,
			Condition_Depression,
			Condition_Diabetes,
			Condition_GallbladderDisease,
			Condition_HeartCirculatory,
			Condition_Hyperlipidemia,
			Condition_Hypertension,
			Condition_MetabolicSyndrome,
			Condition_Migraine,
			Condition_Neurologic,
			Condition_Obesity,
			Condition_Osteoporosis,
			Condition_SleepApnea,
			Condition_StomachBowel,
			Condition_Stroke,
			CurrentHealthProblem,
			Diet_BestMethod,
			Diet_ConfidenceBoredom,
			Diet_ConfidenceHolidays,
			Diet_ConfidenceRestaurant,
			Diet_ConfidenceUpset,
			Diet_FastFoodFrequency,
			Diet_FishServings,
			Diet_FruitServings,
			Diet_GrainServings,
			Diet_MeatAltServings,
			Diet_PoultryServings,
			Diet_RedMeatServings,
			Diet_Resources,
			Diet_StageOfChange,
			Diet_VegServings,
			DriveSpeedLimit,
			Education,
			EmploymentDuration,
			Exercise_AdvisedToIncrease,
			Exercise_BestMethod,
			Exercise_ConfidenceDiscomfort,
			Exercise_ConfidenceHaveTime,
			Exercise_ConfidenceMissGoals,
			Exercise_ConfidenceTired,
			Exercise_Light_Minutes,
			Exercise_Moderate,
			Exercise_Moderate_Minutes,
			Exercise_Resources,
			Exercise_StageOfChange,
			Exercise_Vigorous,
			Exercise_Vigorous_Minutes,
			FastingGlucose,
			FeltDown,
			Gender,
			Goals,
			Hearing_Devices,
			Hearing_Impairment,
			Height_Inches,
			Helmet,
			Immunization_ChickenPox,
			Immunization_Flu,
			Immunization_HepA,
			Immunization_HepB,
			Immunization_Measles,
			Immunization_Meningococcal,
			Immunization_Tetanus,
			Immunization_Zoster,
			Income,
			JobCategory,
			LittleInterest,
			MaritalStatus,
			PainFrequency,
			PainLevel,
			PreferredLanguage,
			PregnancyStatus,
			Presenteeism_Distracted,
			Presenteeism_Energetic,
			Presenteeism_Focus,
			Presenteeism_Hopeless,
			Presenteeism_Stress,
			Presenteeism_Tasks,
			Preventive_Aspirin,
			Preventive_BloodPressure,
			Preventive_Chlamydia,
			Preventive_Cholesterol,
			Preventive_Colonoscopy,
			Preventive_Mammo,
			Preventive_Pap,
			Preventive_Stool,
			ReadingAid,
			RecreationalDrugUse,
			SafeSex,
			SeatBelt,
			SecondhandSmoke,
			SelfRatedHealth,
			SelfRatedHealth_YearAgo,
			Sleep_Hours,
			Sleep_WakeupFeeling,
			Stress_StageOfChange,
			StressLevel_Health,
			StressLevel_Home,
			StressLevel_Work,
			StressManage_Health,
			StressManage_Home,
			StressManage_Work,
			Tobacco_BestMethod,
			Tobacco_ConfidenceMorning,
			Tobacco_ConfidenceSocializing,
			Tobacco_ConfidenceTV,
			Tobacco_ConfidenceUpset,
			Tobacco_QuitDate,
			Tobacco_Resources,
			Tobacco_StageOfChange,
			Tobacco_Use,
			TobaccoStatements,
			Utilization_ERVisits,
			Utilization_InpatientAdmissions,
			Utilization_PhysicianVisits,
			VisionImpairment,
			WaistCircumference,
			Weight_BestMethod,
			Weight_CarryExcess,
			Weight_ConfidenceGeneral,
			Weight_Fluctuation,
			Weight_Pounds,
			Weight_Resources,
			Weight_SelfPerceivedLoss,
			Weight_StageOfChange,
			WorkCulture_Control,
			WorkCulture_Demands,
			WorkCulture_Relationships,
			WorkCulture_Reward,
			WorkCulture_Role,
			WorkCulture_Support
		FROM
			(
			SELECT
				ha.MemberID,
				ha.AssessmentCompleteDate,
				mr.Measure,
				mr.Response
			FROM
				DA_Production.prod.HealthAssessment ha
			JOIN
				DA_Production.prod.HealthAssessment_MeasureResponse mr
				ON	(ha.MemberAssessmentID = mr.MemberAssessmentID)
				AND	(mr.MeasureID IN
						(
						2,4,7,8,9,14,16,21,23,25,26,27,29,30,31,32,33,34,35,36,37,38,39,40,41,43,44,45,46,
						47,48,50,51,52,53,54,55,56,57,58,59,61,67,68,69,70,72,73,74,75,76,77,78,79,80,81,82,
						85,86,87,90,91,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,111,112,116,
						117,118,119,120,121,122,124,125,126,127,128,129,130,136,138,139,140,141,145,147,148,
						149,151,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,
						286,287,288,289,290,291,292,293,294,295,296,297,298,303,304,305,306,307,310,311,312
						)
					)
			WHERE
				ha.HealthPlanID = 68 AND
				ha.SurveyID IN (1,22) AND
				ha.AssessmentCompleteDate >= @inBeginDate AND
				ha.AssessmentCompleteDate < @inEndDate
			) data
		PIVOT
			(
			MAX(Response) FOR Measure IN	(
										[AbsenteeDays],
										[Alcohol_Current],
										[Alcohol_Days5Plus],
										[Alcohol_Frequency],
										[Alcohol_MaxDrinks],
										[Alcohol_Remorse],
										[BloodPressure],
										[Cholesterol],
										[Condition_Allergies],
										[Condition_Arthritis],
										[Condition_Asthma],
										[Condition_BackNeck],
										[Condition_Cancer],
										[Condition_ChronicPain],
										[Condition_COPD],
										[Condition_Depression],
										[Condition_Diabetes],
										[Condition_GallbladderDisease],
										[Condition_HeartCirculatory],
										[Condition_Hyperlipidemia],
										[Condition_Hypertension],
										[Condition_MetabolicSyndrome],
										[Condition_Migraine],
										[Condition_Neurologic],
										[Condition_Obesity],
										[Condition_Osteoporosis],
										[Condition_SleepApnea],
										[Condition_StomachBowel],
										[Condition_Stroke],
										[CurrentHealthProblem],
										[Diet_BestMethod],
										[Diet_ConfidenceBoredom],
										[Diet_ConfidenceHolidays],
										[Diet_ConfidenceRestaurant],
										[Diet_ConfidenceUpset],
										[Diet_FastFoodFrequency],
										[Diet_FishServings],
										[Diet_FruitServings],
										[Diet_GrainServings],
										[Diet_MeatAltServings],
										[Diet_PoultryServings],
										[Diet_RedMeatServings],
										[Diet_Resources],
										[Diet_StageOfChange],
										[Diet_VegServings],
										[DriveSpeedLimit],
										[Education],
										[EmploymentDuration],
										[Exercise_AdvisedToIncrease],
										[Exercise_BestMethod],
										[Exercise_ConfidenceDiscomfort],
										[Exercise_ConfidenceHaveTime],
										[Exercise_ConfidenceMissGoals],
										[Exercise_ConfidenceTired],
										[Exercise_Light_Minutes],
										[Exercise_Moderate],
										[Exercise_Moderate_Minutes],
										[Exercise_Resources],
										[Exercise_StageOfChange],
										[Exercise_Vigorous],
										[Exercise_Vigorous_Minutes],
										[FastingGlucose],
										[FeltDown],
										[Gender],
										[Goals],
										[Hearing_Devices],
										[Hearing_Impairment],
										[Height_Inches],
										[Helmet],
										[Immunization_ChickenPox],
										[Immunization_Flu],
										[Immunization_HepA],
										[Immunization_HepB],
										[Immunization_Measles],
										[Immunization_Meningococcal],
										[Immunization_Tetanus],
										[Immunization_Zoster],
										[Income],
										[JobCategory],
										[LittleInterest],
										[MaritalStatus],
										[PainFrequency],
										[PainLevel],
										[PreferredLanguage],
										[PregnancyStatus],
										[Presenteeism_Distracted],
										[Presenteeism_Energetic],
										[Presenteeism_Focus],
										[Presenteeism_Hopeless],
										[Presenteeism_Stress],
										[Presenteeism_Tasks],
										[Preventive_Aspirin],
										[Preventive_BloodPressure],
										[Preventive_Chlamydia],
										[Preventive_Cholesterol],
										[Preventive_Colonoscopy],
										[Preventive_Mammo],
										[Preventive_Pap],
										[Preventive_Stool],
										[ReadingAid],
										[RecreationalDrugUse],
										[SafeSex],
										[SeatBelt],
										[SecondhandSmoke],
										[SelfRatedHealth],
										[SelfRatedHealth_YearAgo],
										[Sleep_Hours],
										[Sleep_WakeupFeeling],
										[Stress_StageOfChange],
										[StressLevel_Health],
										[StressLevel_Home],
										[StressLevel_Work],
										[StressManage_Health],
										[StressManage_Home],
										[StressManage_Work],
										[Tobacco_BestMethod],
										[Tobacco_ConfidenceMorning],
										[Tobacco_ConfidenceSocializing],
										[Tobacco_ConfidenceTV],
										[Tobacco_ConfidenceUpset],
										[Tobacco_QuitDate],
										[Tobacco_Resources],
										[Tobacco_StageOfChange],
										[Tobacco_Use],
										[TobaccoStatements],
										[Utilization_ERVisits],
										[Utilization_InpatientAdmissions],
										[Utilization_PhysicianVisits],
										[VisionImpairment],
										[WaistCircumference],
										[Weight_BestMethod],
										[Weight_CarryExcess],
										[Weight_ConfidenceGeneral],
										[Weight_Fluctuation],
										[Weight_Pounds],
										[Weight_Resources],
										[Weight_SelfPerceivedLoss],
										[Weight_StageOfChange],
										[WorkCulture_Control],
										[WorkCulture_Demands],
										[WorkCulture_Relationships],
										[WorkCulture_Reward],
										[WorkCulture_Role],
										[WorkCulture_Support]
										)
			) pvt
		) ha
		ON	(mem.MemberID = ha.MemberID)
	WHERE
		grp.HealthPlanID = 68
	
END
GO
